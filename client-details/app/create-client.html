<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Client with Employee - CAPM Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .form-section {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-section h5 {
            color: #495057;
            margin-bottom: 15px;
        }

        .employee-option {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .employee-option:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }

        .employee-option.selected {
            border-color: #007bff;
            background-color: #e3f2fd;
        }

        .result-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-arrow-left me-2"></i>
                Back to Dashboard
            </a>
            <span class="navbar-text">
                <i class="fas fa-user-plus me-1"></i>
                Create Client with Employee Management
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-building me-2"></i>
                            Create Client with Employee Management
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="createClientForm">
                            <!-- Client Information -->
                            <div class="form-section">
                                <h5><i class="fas fa-building me-2"></i>Client Information</h5>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="clientNumber" class="form-label">Client Number *</label>
                                        <input type="text" class="form-control" id="clientNumber" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="clientName" class="form-label">Client Name *</label>
                                        <input type="text" class="form-control" id="clientName" required>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label for="industry" class="form-label">Industry</label>
                                        <select class="form-select" id="industry">
                                            <option value="">Select Industry</option>
                                            <option value="Technology">Technology</option>
                                            <option value="Manufacturing">Manufacturing</option>
                                            <option value="Financial Services">Financial Services</option>
                                            <option value="Healthcare">Healthcare</option>
                                            <option value="Retail">Retail</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="size" class="form-label">Size</label>
                                        <select class="form-select" id="size">
                                            <option value="">Select Size</option>
                                            <option value="Small">Small</option>
                                            <option value="Medium">Medium</option>
                                            <option value="Large">Large</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="website" class="form-label">Website</label>
                                        <input type="url" class="form-control" id="website">
                                    </div>
                                </div>
                            </div>

                            <!-- Employee Selection -->
                            <div class="form-section">
                                <h5><i class="fas fa-user-tie me-2"></i>Account Manager Selection</h5>

                                <div class="mb-3">
                                    <label class="form-label">Choose Employee Option:</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="employeeOption"
                                            id="existingEmployee" value="existing" checked>
                                        <label class="form-check-label" for="existingEmployee">
                                            Use Existing Employee
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="employeeOption"
                                            id="newEmployee" value="new">
                                        <label class="form-check-label" for="newEmployee">
                                            Create New Employee
                                        </label>
                                    </div>
                                </div>

                                <!-- Existing Employee Selection -->
                                <div id="existingEmployeeSection">
                                    <label for="employeeSelect" class="form-label">Select Existing Employee:</label>
                                    <select class="form-select" id="employeeSelect">
                                        <option value="">Loading employees...</option>
                                    </select>
                                </div>

                                <!-- New Employee Form -->
                                <div id="newEmployeeSection" style="display: none;">
                                    <h6 class="mt-3">New Employee Information</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="employeeNumber" class="form-label">Employee Number *</label>
                                            <input type="text" class="form-control" id="employeeNumber">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="firstName" class="form-label">First Name *</label>
                                            <input type="text" class="form-control" id="firstName">
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label for="lastName" class="form-label">Last Name *</label>
                                            <input type="text" class="form-control" id="lastName">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="email" class="form-label">Email *</label>
                                            <input type="email" class="form-control" id="email">
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label for="phone" class="form-label">Phone</label>
                                            <input type="tel" class="form-control" id="phone">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="hireDate" class="form-label">Hire Date *</label>
                                            <input type="date" class="form-control" id="hireDate">
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label for="salary" class="form-label">Salary</label>
                                            <input type="number" class="form-control" id="salary" step="0.01">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="department" class="form-label">Department</label>
                                            <select class="form-select" id="department">
                                                <option value="">Select Department</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <label for="position" class="form-label">Position</label>
                                            <select class="form-select" id="position">
                                                <option value="">Select Position</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save me-2"></i>
                                    Create Client with Employee
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Instructions
                        </h6>
                    </div>
                    <div class="card-body">
                        <h6>How it works:</h6>
                        <ol class="small">
                            <li><strong>Use Existing Employee:</strong> Select from available employees in Employee
                                Master Data</li>
                            <li><strong>Create New Employee:</strong> Create employee in Employee Master Data service
                            </li>
                            <li><strong>Chained Process:</strong> If employee creation fails, client creation is also
                                cancelled</li>
                            <li><strong>Mapping:</strong> Client is only created if employee management succeeds</li>
                        </ol>

                        <h6 class="mt-3">Features:</h6>
                        <ul class="small">
                            <li>Cross-application service calls</li>
                            <li>Transaction-like behavior</li>
                            <li>Error handling and cleanup</li>
                            <li>Real-time employee validation</li>
                        </ul>
                    </div>
                </div>

                <!-- Result Section -->
                <div id="resultSection" class="result-section" style="display: none;">
                    <h6><i class="fas fa-check-circle text-success me-2"></i>Result</h6>
                    <div id="resultContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration
        const config = {
            clientServiceUrl: '/client',
            employeeServiceUrl: '/employee'
        };

        // Global variables
        let employees = [];
        let departments = [];
        let positions = [];

        // Initialize the form
        document.addEventListener('DOMContentLoaded', function () {
            loadEmployees();
            loadDepartments();
            loadPositions();
            setupFormHandlers();
        });

        // Load available employees
        async function loadEmployees() {
            try {
                const response = await fetch(`${config.clientServiceUrl}/getAvailableEmployees`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    employees = await response.json();
                    populateEmployeeSelect();
                }
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        // Load departments
        async function loadDepartments() {
            try {
                const response = await fetch(`${config.employeeServiceUrl}/Departments`);
                if (response.ok) {
                    departments = await response.json();
                    populateDepartmentSelect();
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        // Load positions
        async function loadPositions() {
            try {
                const response = await fetch(`${config.employeeServiceUrl}/Positions`);
                if (response.ok) {
                    positions = await response.json();
                    populatePositionSelect();
                }
            } catch (error) {
                console.error('Error loading positions:', error);
            }
        }

        // Populate employee select
        function populateEmployeeSelect() {
            const select = document.getElementById('employeeSelect');
            select.innerHTML = '<option value="">Select Employee</option>';

            employees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.ID;
                option.textContent = `${employee.firstName} ${employee.lastName} - ${employee.position?.title || 'N/A'}`;
                select.appendChild(option);
            });
        }

        // Populate department select
        function populateDepartmentSelect() {
            const select = document.getElementById('department');
            select.innerHTML = '<option value="">Select Department</option>';

            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.ID;
                option.textContent = dept.name;
                select.appendChild(option);
            });
        }

        // Populate position select
        function populatePositionSelect() {
            const select = document.getElementById('position');
            select.innerHTML = '<option value="">Select Position</option>';

            positions.forEach(pos => {
                const option = document.createElement('option');
                option.value = pos.ID;
                option.textContent = pos.title;
                select.appendChild(option);
            });
        }

        // Setup form handlers
        function setupFormHandlers() {
            // Employee option radio buttons
            document.querySelectorAll('input[name="employeeOption"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    if (this.value === 'existing') {
                        document.getElementById('existingEmployeeSection').style.display = 'block';
                        document.getElementById('newEmployeeSection').style.display = 'none';
                    } else {
                        document.getElementById('existingEmployeeSection').style.display = 'none';
                        document.getElementById('newEmployeeSection').style.display = 'block';
                    }
                });
            });

            // Form submission
            document.getElementById('createClientForm').addEventListener('submit', handleFormSubmit);
        }

        // Handle form submission
        async function handleFormSubmit(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const employeeOption = document.querySelector('input[name="employeeOption"]:checked').value;

            // Prepare request data
            const requestData = {
                clientNumber: document.getElementById('clientNumber').value,
                name: document.getElementById('clientName').value,
                industry: document.getElementById('industry').value,
                size: document.getElementById('size').value,
                website: document.getElementById('website').value,
                createEmployeeIfNotExists: employeeOption === 'new'
            };

            if (employeeOption === 'existing') {
                const employeeId = document.getElementById('employeeSelect').value;
                if (!employeeId) {
                    alert('Please select an employee');
                    return;
                }
                requestData.accountManagerID = employeeId;
            } else {
                // New employee data
                requestData.accountManagerID = null;
                requestData.employeeData = {
                    employeeNumber: document.getElementById('employeeNumber').value,
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    hireDate: document.getElementById('hireDate').value,
                    salary: parseFloat(document.getElementById('salary').value) || 0,
                    departmentID: document.getElementById('department').value,
                    positionID: document.getElementById('position').value
                };
            }

            // Submit the request
            try {
                const response = await fetch(`${config.clientServiceUrl}/createClientWithEmployee`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (response.ok) {
                    showResult('success', result);
                } else {
                    showResult('error', result);
                }
            } catch (error) {
                showResult('error', { message: 'Network error: ' + error.message });
            }
        }

        // Show result
        function showResult(type, data) {
            const resultSection = document.getElementById('resultSection');
            const resultContent = document.getElementById('resultContent');

            let html = '';
            if (type === 'success') {
                html = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle me-2"></i>Success!</h6>
                        <p class="mb-1"><strong>Message:</strong> ${data.message}</p>
                        <p class="mb-1"><strong>Client ID:</strong> ${data.clientID}</p>
                        <p class="mb-1"><strong>Employee ID:</strong> ${data.employeeID}</p>
                        <p class="mb-0"><strong>Employee Created:</strong> ${data.employeeCreated ? 'Yes' : 'No'}</p>
                    </div>
                `;
            } else {
                html = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Error</h6>
                        <p class="mb-0">${data.message || 'An error occurred'}</p>
                    </div>
                `;
            }

            resultContent.innerHTML = html;
            resultSection.style.display = 'block';

            // Scroll to result
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>

</html>